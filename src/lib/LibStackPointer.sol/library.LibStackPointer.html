<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>LibStackPointer</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../book.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../../index.html">Home</a></li><li class="chapter-item affix "><li class="part-title">src</li><li class="chapter-item expanded "><a href="../../../src/lib/index.html">❱ lib</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../src/lib/LibBytes.sol/error.TruncateError.html">TruncateError</a></li><li class="chapter-item "><a href="../../../src/lib/LibBytes.sol/library.LibBytes.html">LibBytes</a></li><li class="chapter-item "><a href="../../../src/lib/LibMemCpy.sol/library.LibMemCpy.html">LibMemCpy</a></li><li class="chapter-item "><a href="../../../src/lib/LibMemory.sol/library.LibMemory.html">LibMemory</a></li><li class="chapter-item "><a href="../../../src/lib/LibPointer.sol/type.Pointer.html">Pointer</a></li><li class="chapter-item "><a href="../../../src/lib/LibPointer.sol/library.LibPointer.html">LibPointer</a></li><li class="chapter-item "><a href="../../../src/lib/LibStackPointer.sol/error.UnalignedStackPointer.html">UnalignedStackPointer</a></li><li class="chapter-item expanded "><a href="../../../src/lib/LibStackPointer.sol/library.LibStackPointer.html" class="active">LibStackPointer</a></li><li class="chapter-item "><a href="../../../src/lib/LibStackSentinel.sol/error.MissingSentinel.html">MissingSentinel</a></li><li class="chapter-item "><a href="../../../src/lib/LibStackSentinel.sol/type.Sentinel.html">Sentinel</a></li><li class="chapter-item "><a href="../../../src/lib/LibStackSentinel.sol/library.LibStackSentinel.html">LibStackSentinel</a></li><li class="chapter-item "><a href="../../../src/lib/LibUint256Array.sol/error.OutOfBoundsTruncate.html">OutOfBoundsTruncate</a></li><li class="chapter-item "><a href="../../../src/lib/LibUint256Array.sol/library.LibUint256Array.html">LibUint256Array</a></li><li class="chapter-item "><a href="../../../src/lib/LibUint256Matrix.sol/library.LibUint256Matrix.html">LibUint256Matrix</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rainprotocol/rain.solmem" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="libstackpointer"><a class="header" href="#libstackpointer">LibStackPointer</a></h1>
<p><a href="https://github.com/rainprotocol/rain.solmem/blob/7b2f04d6e0d7d4573e6b0a17bd9c7b84a7fde05f/src/lib/LibStackPointer.sol">Git Source</a></p>
<p>A stack <code>Pointer</code> is still just a pointer to some memory, but we are
going to treat it like it is pointing to a stack data structure. That means
it can move &quot;up&quot; and &quot;down&quot; (increment and decrement) by <code>uint256</code> (32 bytes)
increments. Structurally a stack is a <code>uint256[]</code> but we can save a lot of
gas vs. default Solidity handling of array indexes by using assembly to
bypass runtime bounds checks on every read and write. Of course, this means
the caller is responsible for ensuring the stack reads and write are not out
of bounds.
The pointer to the bottom of a stack points at the 0th item, NOT the length
of the implied <code>uint256[]</code> and the top of a stack points AFTER the last item.
e.g. consider a <code>uint256[]</code> in memory with values <code>3 A B C</code> and assume this
starts at position <code>0</code> in memory, i.e. <code>0</code> points to value <code>3</code> for the
array length. In this case the stack bottom would be <code>Pointer.wrap(0x20)</code>
(32 bytes above 0, past the length) and the stack top would be
<code>StackPointer.wrap(0x80)</code> (96 bytes above the stack bottom).
Most of the functions in this library are equivalent to each other via
composition, i.e. everything could be achieved with just <code>up</code>, <code>down</code>,
<code>pop</code>, <code>push</code>, <code>peek</code>. The reason there is so much overloaded/duplicated
logic is that the Solidity compiler seems to fail at inlining equivalent
logic quite a lot. Perhaps once the IR compilation of Solidity is better
supported by tooling etc. we could remove a lot of this duplication as the
compiler itself would handle the optimisations.</p>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<h3 id="unsafepeek"><a class="header" href="#unsafepeek">unsafePeek</a></h3>
<p>Read the word immediately below the given stack pointer.
Treats the given pointer as a pointer to the top of the stack, so <code>peek</code>
reads the word below the pointer.
https://en.wikipedia.org/wiki/Peek_(data_type_operation)
The caller MUST ensure this read is not out of bounds, e.g. a <code>peek</code> to
<code>0</code> will underflow (and exhaust gas attempting to read).</p>
<pre><code class="language-solidity">function unsafePeek(Pointer pointer) internal pure returns (uint256 word);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>pointer</code></td><td><code>Pointer</code></td><td>Pointer to the top of the stack to read below.</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>word</code></td><td><code>uint256</code></td><td>The word that was read.</td></tr>
</tbody></table>
</div>
<h3 id="unsafepeek2"><a class="header" href="#unsafepeek2">unsafePeek2</a></h3>
<p>Peeks 2 words from the top of the stack.
Same as <code>unsafePeek</code> but returns 2 words instead of 1.</p>
<pre><code class="language-solidity">function unsafePeek2(Pointer pointer) internal pure returns (uint256 lower, uint256 upper);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>pointer</code></td><td><code>Pointer</code></td><td>The stack top to peek below.</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>lower</code></td><td><code>uint256</code></td><td>The lower of the two words read.</td></tr>
<tr><td><code>upper</code></td><td><code>uint256</code></td><td>The upper of the two words read.</td></tr>
</tbody></table>
</div>
<h3 id="unsafepop"><a class="header" href="#unsafepop">unsafePop</a></h3>
<p>Pops the word from the top of the stack.
Treats the given pointer as a pointer to the top of the stack, so <code>pop</code>
reads the word below the pointer. The popped pointer is returned
alongside the read word.
https://en.wikipedia.org/wiki/Stack_(abstract_data_type)
The caller MUST ensure the pop will not result in an out of bounds read.</p>
<pre><code class="language-solidity">function unsafePop(Pointer pointer) internal pure returns (Pointer pointerAfter, uint256 word);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>pointer</code></td><td><code>Pointer</code></td><td>Pointer to the top of the stack to read below.</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>pointerAfter</code></td><td><code>Pointer</code></td><td>Pointer after the pop.</td></tr>
<tr><td><code>word</code></td><td><code>uint256</code></td><td>The word that was read.</td></tr>
</tbody></table>
</div>
<h3 id="unsafepush"><a class="header" href="#unsafepush">unsafePush</a></h3>
<p>Pushes a word to the top of the stack.
Treats the given pointer as a pointer to the top of the stack, so <code>push</code>
writes a word at the pointer. The pushed pointer is returned.
https://en.wikipedia.org/wiki/Stack_(abstract_data_type)
The caller MUST ensure the push will not result in an out of bounds
write.</p>
<pre><code class="language-solidity">function unsafePush(Pointer pointer, uint256 word) internal pure returns (Pointer);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>pointer</code></td><td><code>Pointer</code></td><td>The stack pointer to write at.</td></tr>
<tr><td><code>word</code></td><td><code>uint256</code></td><td>The value to write.</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>Pointer</code></td><td>The stack pointer above where <code>word</code> was written to.</td></tr>
</tbody></table>
</div>
<h3 id="unsafelist"><a class="header" href="#unsafelist">unsafeList</a></h3>
<p>Returns <code>length</code> values from the stack as an array without allocating
new memory. As arrays always start with their length, this requires
writing the length value to the stack below the array values. The value
that is overwritten in the process is also returned so that data is not
lost. For example, imagine a stack <code>[ A B C D ]</code> and we list 2 values.
This will write the stack to look like <code>[ A 2 C D ]</code> and return both <code>B</code>
and a pointer to <code>2</code> represented as a <code>uint256[]</code>.
The returned array is ONLY valid for as long as the stack DOES NOT move
back into its memory. As soon as the stack moves up again and writes into
the array it will be corrupt. The caller MUST ensure that it does not
read from the returned array after it has been corrupted by subsequent
stack writes.</p>
<pre><code class="language-solidity">function unsafeList(Pointer pointer, uint256 length) internal pure returns (uint256 head, uint256[] memory tail);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>pointer</code></td><td><code>Pointer</code></td><td>The stack pointer to read the values below into an array.</td></tr>
<tr><td><code>length</code></td><td><code>uint256</code></td><td>The number of values to include in the returned array.</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>head</code></td><td><code>uint256</code></td><td>The value that was overwritten with the length.</td></tr>
<tr><td><code>tail</code></td><td><code>uint256[]</code></td><td>The array constructed from the stack memory.</td></tr>
</tbody></table>
</div>
<h3 id="toindexsigned"><a class="header" href="#toindexsigned">toIndexSigned</a></h3>
<p>Convert two stack pointer values to a single stack index. A stack index
is the distance in 32 byte increments between two stack pointers. The
calculations require the two stack pointers are aligned. If the pointers
are not aligned, the function will revert.</p>
<pre><code class="language-solidity">function toIndexSigned(Pointer lower, Pointer upper) internal pure returns (int256);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>lower</code></td><td><code>Pointer</code></td><td>The lower of the two values.</td></tr>
<tr><td><code>upper</code></td><td><code>Pointer</code></td><td>The higher of the two values.</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>int256</code></td><td>The stack index as 32 byte words distance between the top and bottom. Negative if <code>lower</code> is above <code>upper</code>.</td></tr>
</tbody></table>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../src/lib/LibStackPointer.sol/error.UnalignedStackPointer.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../../src/lib/LibStackSentinel.sol/error.MissingSentinel.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../src/lib/LibStackPointer.sol/error.UnalignedStackPointer.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../../src/lib/LibStackSentinel.sol/error.MissingSentinel.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../../solidity.min.js"></script>


    </div>
    </body>
</html>
